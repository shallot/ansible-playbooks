# Copyright (c) 2018-present eyeo GmbH
#
# This module is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

---

# A list of SSH keys that can be used to access ansible@localhost:inventory
# using Git from the Ansible host itself. In production this should include
# the public keys of anyone who is allowed to modify the inventory and will
# require SSH agent forwarding. In development it uses the existing Vagrant
# user and the key generated by the provision-ansible-admin-hosts.yml playbook.
custom_ansible_authorized_keys:
  - "{{ custom_vagrant_user.ssh_public_key }}"
  - "ssh-rsa This is just an example of a second SSH key"

# A list of hosts/IP addresses that can be used to access
# ansible@localhost:inventory on the Ansible host. In production,
# this should include the addresses of any backup Ansible hosts.
custom_ansible_authorized_from_hosts:
  - "127.0.0.1"
  - "::1"

# A list of users to be included with group ansible, i.e. ones that can access
# group-readable files within the ~ansible/inventory repository. In development
# this includes only the vagrant user, while in production it includes the name
# of anyone who is able to provision confidential resources.
custom_ansible_group_members:
  - "vagrant"

# The source URL of the playbooks repository. Uses the existing Vagrant share
# in development (refer to https://www.vagrantup.com/docs/synced-folders/ for
# details). The public repository URL is used in staging and production, i.e.
# https://gitlab.com/eyeo/devops/ansible-playbooks
custom_ansible_playbooks_repository:
  "/vagrant"

ansible_host_vars_lint_hooks_dir:
  "{{ custom_ansible_user.home }}/inventory-host-vars-lint"

ansible_host_vars_lint_hooks_custom_paths__to_merge:
  "{{ ansible_host_vars_lint_hooks_dir }}":
    state: "directory"
    dest: "{{ ansible_host_vars_lint_hooks_dir }}"
    mode: "0755"
  "{{ ansible_host_vars_lint_hooks_dir }}/inventory-host-vars-lint":
    state: "copy"
    dest: "{{ ansible_host_vars_lint_hooks_dir }}/inventory-host-vars-lint"
    # yamllint disable rule:line-length
    content: |
      #!/bin/sh

      missing_host_vars=""

      for h in $(PYTHONWARNINGS=ignore::UserWarning ANSIBLE_TRANSFORM_INVALID_GROUP_CHARS=silently \
          ansible all --list-hosts | tail -n +2); do
              test -e host_vars/$i.yml || missing_host_vars="$missing_host_vars $h"
      done

      if [ ! -z "$missing_host_vars" ]; then
              echo "Missing host_vars files:"

              for h in $missing_host_vars; do
                      echo "\thost_vars/$h.yml"
              done

              exit 1
      fi
    # yamllint enable rule:line-length
    mode: "0755"
  "{{ ansible_host_vars_lint_hooks_dir }}/.pre-commit-hooks.yaml":
    state: "copy"
    dest: "{{ ansible_host_vars_lint_hooks_dir }}/.pre-commit-hooks.yaml"
    content: |
      ---

      # For use with pre-commit.
      # See usage instructions at https://pre-commit.com/#new-hooks

      - id: inventory-host-vars-lint
        name: inventory-host-vars-lint
        description: Checks if every ansible host as a host_vars file.
        entry: {{ ansible_host_vars_lint_hooks_dir }}/inventory-host-vars-lint
        language: system
        types: [file]
    mode: "0644"

ansible_host_vars_lint_hooks_custom_shells__to_merge:
  ab_git_setup:
    cmd: "git init && git add . && git commit -m 'Init commit' && git tag v0.1"
    chdir: "{{ ansible_host_vars_lint_hooks_dir }}"
    creates: "{{ ansible_host_vars_lint_hooks_dir }}/.git"

# Fix permissions of ansible home after host_vars pre-commit is set up
ansible_host_vars_lint_hooks_ansible_admin_commands__to_merge:
  aa_ansible_home_owner_reset:
    cmd: "chown -R ansible: {{ custom_ansible_user.home }}"

ansible_host_vars_lint_hook_custom_packages__to_merge:
  git: "present"

# https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html
vagrant_groups:
  - "ansible-admin-hosts"

# https://www.vagrantup.com/intro/getting-started/networking.html
vagrant_networks:
  - private_network:
      ip: "10.8.10.8"

# https://www.vagrantup.com/docs/provisioning/ansible.html
vagrant_playbooks:
  - "provision-custom-systems.yml"
  - "provision-custom-shells.yml"
  - "provision-ansible-admin-hosts.yml"

# https://www.vagrantup.com/docs/synced-folders/rsync.html
vagrant_rsync:
  true

# https://www.vagrantup.com/docs/providers/configuration
vagrant_memory:
  512
