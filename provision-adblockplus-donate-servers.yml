# Copyright (c) 2020-present eyeo GmbH
#
# This module is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

---

- name:
    "provision-adblockplus-donate-servers"

  hosts:
    "adblockplus-donate-servers"

  pre_tasks:

    # https://docs.ansible.com/ansible/latest/import_tasks_module.html
    - import_tasks:
        "tasks/os/main.yml"

    # https://docs.ansible.com/ansible/latest/import_tasks_module.html
    - import_tasks:
        "tasks/apache2.yml"

    # https://docs.ansible.com/ansible/latest/import_role_module.html
    - import_role:
        name: "gitlab/runner"

    # https://docs.ansible.com/ansible/latest/modules/apt_module.html
    - name:
        "apt"
      apt:
        cache_valid_time: "{{ apt_cache_valid_time }}"
        default_release: "{{ apt_default_release | default(omit) }}"
        name:
          - "python3-pip"
          - "rsync"
          - "virtualenv"
        state: "present"
        update_cache: "{{ apt_update_cache }}"
      become:
        true

    # https://docs.ansible.com/ansible/latest/modules/file_module.html
    - name:
        "seed : {{ adblockplus_donate_server_dir }}"
      file:
        path: "{{ adblockplus_donate_server_dir }}"
        state: "directory"
      become:
        true

    # https://docs.ansible.com/ansible/latest/modules/find_module.html
    - name:
        "find : {{ adblockplus_donate_server_dir }}"
      find:
        depth: 1
        file_type: "any"
        paths: "{{ adblockplus_donate_server_dir }}"
        recurse: false
      changed_when:
        false
      register:
        "adblockplus_donate_server_dir_files"
      become:
        true
      become_user:
        "{{ adblockplus_donate_system_username }}"

    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html
    - block:

        # https://docs.ansible.com/ansible/latest/modules/copy_module.html
        - name:
            "seed : {{ adblockplus_donate_server_dir }}/server.env"
          copy:
            dest: "{{ adblockplus_donate_server_dir }}/server.env"
            force: false
            mode: "0664"
            owner: "{{ adblockplus_donate_system_username }}"
            content: |
              # stub
          become:
            true

        # https://docs.ansible.com/ansible/latest/modules/copy_module.html
        - name:
            # yamllint disable rule:line-length
            "seed : {{ adblockplus_donate_server_dir }}/adblockplusDonationServer.py"
            # yamllint enable rule:line-length
          copy:
            # yamllint disable rule:line-length
            dest: "{{ adblockplus_donate_server_dir }}/adblockplusDonationServer.py"
            # yamllint enable rule:line-length
            force: false
            mode: "0755"
            owner: "{{ adblockplus_donate_system_username }}"
            content: |
              #!/usr/bin/python3
              # stub
          become:
            true

      when:
        "adblockplus_donate_server_dir_files.matched < 2"

    # https://docs.ansible.com/ansible/latest/copy_module.html
    - name:
        "file : /etc/systemd/system/adblockplus-donate-server.service"
      copy:
        dest: "/etc/systemd/system/adblockplus-donate-server.service"
        mode: "0644"
        # yamllint disable rule:line-length
        content: |
          [Unit]
          Description="Run AdBlockPlus Donate server"
          After=network.target

          [Service]
          Type=simple
          User={{ adblockplus_donate_system_username }}
          EnvironmentFile={{ adblockplus_donate_server_dir }}/server.env
          ExecStart={{ adblockplus_donate_server_dir }}/adblockplusDonationServer.py
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
        # yamllint enable rule:line-length
      register:
        "adblockplus_donate_server_service"
      become:
        true

    # https://docs.ansible.com/ansible/latest/modules/systemd_module.html
    - name:
        "systemd : daemon-reload"
      systemd:
        daemon_reload: true
      when:
        "adblockplus_donate_server_service.changed"
      become:
        true

    # https://docs.ansible.com/ansible/latest/modules/service_module.html
    - name:
        "service : adblockplus-donate-server.service"
      service:
        enabled: true
        name: "adblockplus-donate-server.service"
        state: "started"
      become:
        true

    # https://docs.ansible.com/ansible/latest/copy_module.html
    - name:
        "file : /etc/systemd/system/adblockplus-donate-server.service"
      copy:
        dest: "/usr/local/sbin/deploy-adblockplus-donate-server"
        mode: "0744"
        # yamllint disable rule:line-length
        content: |
          #!/bin/sh -ex
          user="{{ adblockplus_donate_system_username }}"
          id "$user" || exit 1
          dest_dir="{{ adblockplus_donate_server_dir }}"
          test -d "$dest_dir" || exit 2
          SOURCE_DIR=$1
          test -d "$SOURCE_DIR" || exit 3
          sudo install -d -o $user $dest_dir
          sudo -u $user rsync -aHAX --del \
                              --exclude=etc/stripe.secret \
                              -vP --stats \
                                $SOURCE_DIR/ \
                                $dest_dir/
          sudo systemctl status adblockplus-donate-server || true
          sudo systemctl restart adblockplus-donate-server
          sudo systemctl status adblockplus-donate-server
        # yamllint enable rule:line-length
      become:
        true

    # https://docs.ansible.com/ansible/latest/copy_module.html
    - name:
        "file : /etc/sudoers.d/deploy-adblockplus-donate-server"
      copy:
        # yamllint disable rule:line-length
        dest: "/etc/sudoers.d/deploy-adblockplus-donate-server"
        # yamllint enable rule:line-length
        mode: "0440"
        # yamllint disable rule:line-length
        content: |
          Defaults:gitlab-runner env_keep += "CI_COMMIT_REF_SLUG"
          gitlab-runner ALL=(root) NOPASSWD: /usr/local/sbin/deploy-adblockplus-donate-server
        # yamllint enable rule:line-length
        validate:
          "/usr/sbin/visudo --check --file=%s"
      become:
        true
